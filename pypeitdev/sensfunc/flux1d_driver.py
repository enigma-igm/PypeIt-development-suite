
## Standard star
#datapath = os.path.join(os.getenv('HOME'),'Dropbox/PypeIt_Redux/XSHOOTER/J0439/NIR/Science/')
#fnames = [datapath + 'spec1d_XSHOO.2018-11-08T00:11:57.074-Feige110_XShooter_NIR_2018Nov08T001157.074.fits',
#          datapath + 'spec1d_XSHOO.2018-11-08T00:16:56.583-Feige110_XShooter_NIR_2018Nov08T001656.583.fits']

## Lensed Quasar
'''
datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/J0439_old/vlt_xshooter_nir/Science/')
fnames = [datapath + 'J0439_XSHOOTER_NIR_01.fits', datapath + 'J0439_XSHOOTER_NIR_02.fits',
          datapath + 'J0439_XSHOOTER_NIR_03.fits', datapath + 'J0439_XSHOOTER_NIR_04.fits',
          datapath + 'J0439_XSHOOTER_NIR_05.fits', datapath + 'J0439_XSHOOTER_NIR_06.fits',
          datapath + 'J0439_XSHOOTER_NIR_07.fits', datapath + 'J0439_XSHOOTER_NIR_08.fits',
          datapath + 'J0439_XSHOOTER_NIR_09.fits', datapath + 'J0439_XSHOOTER_NIR_10.fits',
          datapath + 'J0439_XSHOOTER_NIR_11.fits', datapath + 'J0439_XSHOOTER_NIR_12.fits',
          datapath + 'J0439_XSHOOTER_NIR_13.fits', datapath + 'J0439_XSHOOTER_NIR_14.fits',
          datapath + 'J0439_XSHOOTER_NIR_15.fits', datapath + 'J0439_XSHOOTER_NIR_16.fits',
          datapath + 'J0439_XSHOOTER_NIR_17.fits', datapath + 'J0439_XSHOOTER_NIR_18.fits',
          datapath + 'J0439_XSHOOTER_NIR_19.fits', datapath + 'J0439_XSHOOTER_NIR_20.fits',
          datapath + 'J0439_XSHOOTER_NIR_21.fits', datapath + 'J0439_XSHOOTER_NIR_22.fits',
          datapath + 'J0439_XSHOOTER_NIR_23.fits', datapath + 'J0439_XSHOOTER_NIR_24.fits',
          datapath + 'J0439_XSHOOTER_NIR_25.fits', datapath + 'J0439_XSHOOTER_NIR_26.fits',
          datapath + 'J0439_XSHOOTER_NIR_27.fits', datapath + 'J0439_XSHOOTER_NIR_28.fits',
          datapath + 'J0439_XSHOOTER_NIR_29.fits', datapath + 'J0439_XSHOOTER_NIR_30.fits',
          datapath + 'J0439_XSHOOTER_NIR_31.fits', datapath + 'J0439_XSHOOTER_NIR_32.fits',
          datapath + 'J0439_XSHOOTER_NIR_33.fits', datapath + 'J0439_XSHOOTER_NIR_34.fits',
          datapath + 'J0439_XSHOOTER_NIR_35.fits', datapath + 'J0439_XSHOOTER_NIR_36.fits',
          datapath + 'J0439_XSHOOTER_NIR_37.fits', datapath + 'J0439_XSHOOTER_NIR_38.fits']
'''

'''
## Pisco
datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/Pypeit_files/PISCO_NIR/Science/')
fnames = [datapath + 'spec1d_XSHOO.2017-06-28T23:51:39.115-PSOJ205p09_1_XShooter_NIR_2017Jun28T235139.115.fits',
          datapath + 'spec1d_XSHOO.2017-06-29T00:12:24.992-PSOJ205p09_1_XShooter_NIR_2017Jun29T001224.992.fits',
          datapath + 'spec1d_XSHOO.2018-02-15T08:07:00.164-PSOJ205p09_2_XShooter_NIR_2018Feb15T080700.164.fits',
          datapath + 'spec1d_XSHOO.2018-02-15T08:27:44.713-PSOJ205p09_2_XShooter_NIR_2018Feb15T082744.713.fits',
          datapath + 'spec1d_XSHOO.2018-03-10T05:08:40.055-PSOJ205p09_3_XShooter_NIR_2018Mar10T050840.055.fits',
          datapath + 'spec1d_XSHOO.2018-03-10T05:29:25.933-PSOJ205p09_3_XShooter_NIR_2018Mar10T052925.933.fits',
          datapath + 'spec1d_XSHOO.2018-03-10T05:58:33.093-PSOJ205p09_4_XShooter_NIR_2018Mar10T055833.093.fits',
          datapath + 'spec1d_XSHOO.2018-03-10T06:19:22.960-PSOJ205p09_4_XShooter_NIR_2018Mar10T061922.960.fits',
          datapath + 'spec1d_XSHOO.2018-03-11T08:41:01.429-PSOJ205p09_5_XShooter_NIR_2018Mar11T084101.429.fits',
          datapath + 'spec1d_XSHOO.2018-03-11T09:01:47.309-PSOJ205p09_5_XShooter_NIR_2018Mar11T090147.309.fits',
          datapath + 'spec1d_XSHOO.2018-03-18T06:26:29.402-PSOJ205p09_6_XShooter_NIR_2018Mar18T062629.402.fits',
          datapath + 'spec1d_XSHOO.2018-03-18T06:47:15.945-PSOJ205p09_6_XShooter_NIR_2018Mar18T064715.945.fits',
          datapath + 'spec1d_XSHOO.2018-03-18T08:32:32.302-PSOJ205p09_7_XShooter_NIR_2018Mar18T083232.302.fits',
          datapath + 'spec1d_XSHOO.2018-03-18T08:53:18.845-PSOJ205p09_7_XShooter_NIR_2018Mar18T085318.845.fits',
          datapath + 'spec1d_XSHOO.2018-03-20T05:22:01.367-PSOJ205p09_8_XShooter_NIR_2018Mar20T052201.367.fits',
          datapath + 'spec1d_XSHOO.2018-03-20T05:42:48.575-PSOJ205p09_8_XShooter_NIR_2018Mar20T054248.575.fits',
          datapath + 'spec1d_XSHOO.2018-03-21T06:06:09.751-PSOJ205p09_9_XShooter_NIR_2018Mar21T060609.751.fits',
          datapath + 'spec1d_XSHOO.2018-03-21T06:26:55.631-PSOJ205p09_9_XShooter_NIR_2018Mar21T062655.631.fits',
          datapath + 'spec1d_XSHOO.2018-03-21T07:13:08.797-PSOJ205p09_10_XShooter_NIR_2018Mar21T071308.797.fits',
          datapath + 'spec1d_XSHOO.2018-03-21T07:33:56.008-PSOJ205p09_10_XShooter_NIR_2018Mar21T073356.008.fits',
          datapath + 'spec1d_XSHOO.2018-03-22T05:00:30.229-PSOJ205p09_11_XShooter_NIR_2018Mar22T050030.229.fits',
          datapath + 'spec1d_XSHOO.2018-03-22T05:21:17.439-PSOJ205p09_11_XShooter_NIR_2018Mar22T052117.439.fits',
          datapath + 'spec1d_XSHOO.2018-03-22T06:01:30.465-PSOJ205p09_12_XShooter_NIR_2018Mar22T060130.465.fits',
          datapath + 'spec1d_XSHOO.2018-03-22T06:22:17.675-PSOJ205p09_12_XShooter_NIR_2018Mar22T062217.675.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T04:45:05.305-PSOJ205p09_13_XShooter_NIR_2018Mar23T044505.305.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T05:05:50.520-PSOJ205p09_13_XShooter_NIR_2018Mar23T050550.520.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T05:43:50.910-PSOJ205p09_14_XShooter_NIR_2018Mar23T054350.910.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T06:04:37.452-PSOJ205p09_14_XShooter_NIR_2018Mar23T060437.452.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T06:37:00.347-PSOJ205p09_15_XShooter_NIR_2018Mar23T063700.347.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T06:57:45.561-PSOJ205p09_16_XShooter_NIR_2018Mar23T065745.561.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T07:36:36.220-PSOJ205p09_16_XShooter_NIR_2018Mar23T073636.220.fits',
          datapath + 'spec1d_XSHOO.2018-03-23T07:57:23.428-PSOJ205p09_16_XShooter_NIR_2018Mar23T075723.428.fits',
          datapath + 'spec1d_XSHOO.2018-03-24T05:20:10.198-PSOJ205p09_17_XShooter_NIR_2018Mar24T052010.198.fits',
          datapath + 'spec1d_XSHOO.2018-03-24T05:40:56.740-PSOJ205p09_17_XShooter_NIR_2018Mar24T054056.740.fits',
          datapath + 'spec1d_XSHOO.2018-03-24T06:17:18.332-PSOJ205p09_18_XShooter_NIR_2018Mar24T061718.332.fits',
          datapath + 'spec1d_XSHOO.2018-03-24T06:38:05.542-PSOJ205p09_18_XShooter_NIR_2018Mar24T063805.542.fits',
          datapath + 'spec1d_XSHOO.2018-03-24T07:13:35.465-PSOJ205p09_19_XShooter_NIR_2018Mar24T071335.465.fits',
          datapath + 'spec1d_XSHOO.2018-03-24T07:34:22.671-PSOJ205p09_19_XShooter_NIR_2018Mar24T073422.671.fits',
          datapath + 'spec1d_XSHOO.2018-03-25T05:18:51.790-PSOJ205p09_20_XShooter_NIR_2018Mar25T051851.790.fits',
          datapath + 'spec1d_XSHOO.2018-03-25T05:39:38.333-PSOJ205p09_20_XShooter_NIR_2018Mar25T053938.333.fits',
          datapath + 'spec1d_XSHOO.2018-03-26T06:36:32.911-PSOJ205p09_21_XShooter_NIR_2018Mar26T063632.911.fits',
          datapath + 'spec1d_XSHOO.2018-03-26T06:57:20.118-PSOJ205p09_21_XShooter_NIR_2018Mar26T065720.118.fits',
          datapath + 'spec1d_XSHOO.2018-03-27T06:57:29.269-PSOJ205p09_22_XShooter_NIR_2018Mar27T065729.269.fits',
          datapath + 'spec1d_XSHOO.2018-03-27T07:18:15.146-PSOJ205p09_22_XShooter_NIR_2018Mar27T071815.146.fits',
          datapath + 'spec1d_XSHOO.2018-04-08T04:59:57.666-PSOJ205p09_23_XShooter_NIR_2018Apr08T045957.666.fits',
          datapath + 'spec1d_XSHOO.2018-04-08T05:20:44.206-PSOJ205p09_23_XShooter_NIR_2018Apr08T052044.206.fits',
          datapath + 'spec1d_XSHOO.2018-04-08T05:57:54.622-PSOJ205p09_24_XShooter_NIR_2018Apr08T055754.622.fits',
          datapath + 'spec1d_XSHOO.2018-04-08T06:18:42.492-PSOJ205p09_24_XShooter_NIR_2018Apr08T061842.492.fits',
          datapath + 'spec1d_XSHOO.2018-04-09T04:59:20.273-PSOJ205p09_25_XShooter_NIR_2018Apr09T045920.273.fits',
          datapath + 'spec1d_XSHOO.2018-04-09T05:20:06.817-PSOJ205p09_25_XShooter_NIR_2018Apr09T052006.817.fits',
          datapath + 'spec1d_XSHOO.2018-04-09T05:58:52.879-PSOJ205p09_26_XShooter_NIR_2018Apr09T055852.879.fits',
          datapath + 'spec1d_XSHOO.2018-04-09T06:19:39.420-PSOJ205p09_26_XShooter_NIR_2018Apr09T061939.420.fits',
          datapath + 'spec1d_XSHOO.2018-04-10T05:07:58.959-PSOJ205p09_27_XShooter_NIR_2018Apr10T050758.959.fits',
          datapath + 'spec1d_XSHOO.2018-04-10T05:28:46.165-PSOJ205p09_27_XShooter_NIR_2018Apr10T052846.165.fits',
          datapath + 'spec1d_XSHOO.2018-04-10T06:05:42.360-PSOJ205p09_28_XShooter_NIR_2018Apr10T060542.360.fits',
          datapath + 'spec1d_XSHOO.2018-04-10T06:26:30.231-PSOJ205p09_28_XShooter_NIR_2018Apr10T062630.231.fits',
          datapath + 'spec1d_XSHOO.2018-04-15T04:58:27.291-PSOJ205p09_29_XShooter_NIR_2018Apr15T045827.291.fits',
          datapath + 'spec1d_XSHOO.2018-04-15T05:19:15.167-PSOJ205p09_29_XShooter_NIR_2018Apr15T051915.167.fits',
          datapath + 'spec1d_XSHOO.2018-04-15T05:59:39.364-PSOJ205p09_30_XShooter_NIR_2018Apr15T055939.364.fits',
          datapath + 'spec1d_XSHOO.2018-04-15T06:20:25.908-PSOJ205p09_30_XShooter_NIR_2018Apr15T062025.908.fits',
          datapath + 'spec1d_XSHOO.2018-04-16T04:23:25.898-PSOJ205p09_31_XShooter_NIR_2018Apr16T042325.898.fits',
          datapath + 'spec1d_XSHOO.2018-04-16T04:44:12.441-PSOJ205p09_31_XShooter_NIR_2018Apr16T044412.441.fits',
          datapath + 'spec1d_XSHOO.2018-04-16T05:26:58.617-PSOJ205p09_32_XShooter_NIR_2018Apr16T052658.617.fits',
          datapath + 'spec1d_XSHOO.2018-04-16T05:47:45.160-PSOJ205p09_32_XShooter_NIR_2018Apr16T054745.160.fits']
'''
## DES z~6.9 Quasar
datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/J0020-3653/NIR/Science/')
fnames = [datapath + 'spec1d_XSHOO.2017-10-26T00:26:41.612-VHSJ0020-3653_XShooter_NIR_2017Oct26T002641.612.fits',
          datapath + 'spec1d_XSHOO.2017-10-26T00:48:55.512-VHSJ0020-3653_XShooter_NIR_2017Oct26T004855.512.fits',
          datapath + 'spec1d_XSHOO.2017-12-17T02:44:43.537-VHSJ0020-3653_XShooter_NIR_2017Dec17T024443.537.fits']
#          datapath + 'spec1d_XSHOO.2017-12-17T03:05:50.032-VHSJ0020-3653_XShooter_NIR_2017Dec17T030550.032.fits']

## DES z~6.5 Quasar J0224
#datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/J0224-4711/pypeit_nir/Science/')
#fnames = [
#    datapath + 'spec1d_XSHOO.2017-11-23T06:52:51.782-VDESJ0224-4711blindoffset_XShooter_NIR_2017Nov23T065251.782.fits',
#    datapath + 'spec1d_XSHOO.2017-11-23T07:13:18.374-VDESJ0224-4711blindoffset_XShooter_NIR_2017Nov23T071318.374.fits',
#    datapath + 'spec1d_XSHOO.2018-01-19T01:57:51.708-VDESJ0224-4711blindoffset_XShooter_NIR_2018Jan19T015751.708.fits',
#    datapath + 'spec1d_XSHOO.2018-01-19T02:18:18.297-VDESJ0224-4711blindoffset_XShooter_NIR_2018Jan19T021818.297.fits']

##J0226
#datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/J0226+0302/pypeit_nir/Science/')
#fnames = [datapath + 'spec1d_XSHOO.2017-12-17T03:50:47.125-PSOJ036.5078blindoffset_XShooter_NIR_2017Dec17T035047.125.fits',
#          datapath + 'spec1d_XSHOO.2017-12-17T04:11:13.716-PSOJ036.5078blindoffset_XShooter_NIR_2017Dec17T041113.716.fits',
#          datapath + 'spec1d_XSHOO.2018-01-14T02:12:34.014-PSOJ036.5078blindoffset_XShooter_NIR_2018Jan14T021234.014.fits',
#          datapath + 'spec1d_XSHOO.2018-01-14T02:33:00.603-PSOJ036.5078blindoffset_XShooter_NIR_2018Jan14T023300.603.fits']

## Standard star
#datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/J0020-3653/NIR/Science/')
#fnames = [datapath + 'spec1d_STD,FLUX_XShooter_NIR_2017Dec17T081653.582.fits',
#          datapath + 'spec1d_STD,FLUX_XShooter_NIR_2017Dec17T082243.751.fits']

## Telluric star
#datapath = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/J0224-4711/Test_tell/')
#fnames = [datapath + 'spec1d_XSHOO.2017-11-23T07:44:02.747-STD,TELLURIC_XShooter_NIR_2017Nov23T074402.747.fits',
#          datapath + 'spec1d_XSHOO.2017-11-23T07:44:57.633-STD,TELLURIC_XShooter_NIR_2017Nov23T074457.633.fits',
#          datapath + 'spec1d_XSHOO.2017-11-23T07:46:53.532-STD,TELLURIC_XShooter_NIR_2017Nov23T074653.532.fits',
#          datapath + 'spec1d_XSHOO.2017-11-23T07:47:33.917-STD,TELLURIC_XShooter_NIR_2017Nov23T074733.917.fits']

##J1048
#datapath = os.path.join(os.getenv('HOME'), 'Dropbox/OBS_DATA/XSHOOTER/NIR/ut20170202/Science/')
#fnames = [datapath + 'spec1d_XSHOO.2017-02-02T04:19:28.545-VIKJ1048m0109_XShooter_NIR_2017Feb02T041928.545.fits',
#          datapath + 'spec1d_XSHOO.2017-02-02T04:40:14.422-VIKJ1048m0109_XShooter_NIR_2017Feb02T044014.422.fits',
#          datapath + 'spec1d_XSHOO.2017-02-02T05:17:52.162-VIKJ1048m0109_XShooter_NIR_2017Feb02T051752.162.fits']

#sensfile = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/NIR_Stack/Feige110_sens_tell_wang.fits')
sensfile = os.path.join(os.getenv('HOME'), 'Dropbox/PypeIt_Redux/XSHOOTER/LTT3218_sens_tell.fits')
apply_sensfunc(fnames, sensfile, extinct_correct=False, tell_correct=False, debug=False, show=False)
objids = ['OBJ0001']*3
outfile = 'VHSJ0020-3653'
fnames_flux  = [file.replace('.fits', '_flux.fits') for file in fnames]
wave_stack, flux_stack, ivar_stack, mask_stack = coadd1d.ech_combspec(fnames_flux, objids, show=True, sensfile=sensfile,
                                                                      ex_value='OPT', outfile=outfile, debug=True)


'''
## test find standard
star_mag  = None
star_type = None
spec1dfile = os.path.join(os.getenv('HOME'),'Dropbox/PypeIt_Redux/XSHOOTER/J0439/NIR/Science/spec1d_XSHOO.2018-11-08T00:16:56.583-Feige110_XShooter_NIR_2018Nov08T001656.583.fits')
header = fits.getheader(spec1dfile)
ra=header['RA']
dec=header['DEC']
std_dict = get_standard_spectrum(star_type=star_type, star_mag=star_mag, ra=ra, dec=dec)

### Grid
from astropy.io import fits
telgridfile = os.path.join(os.getenv('HOME'),'Dropbox/PypeIt_Redux/XSHOOTER/TelFit_Paranal_NIR_9800_25000_R25000.fits')
#from telluric import read_telluric_grid
#tell_dict = read_telluric_grid(tellgridfile, wave_min=None, wave_max=None, pad = 0)

wave_min = None
wave_max = None
pad = 0

hdul = fits.open(telgridfile)
wave_grid_full = 10.0 * hdul[1].data
model_grid_full = hdul[0].data
nspec_full = wave_grid_full.size

if wave_min is not None:
    ind_lower = np.argmin(np.abs(wave_grid_full - wave_min)) - pad
else:
    ind_lower = 0
if wave_max is not None:
    ind_upper = np.argmin(np.abs(wave_grid_full - wave_max)) + pad
else:
    ind_upper = nspec_full
wave_grid = wave_grid_full[ind_lower:ind_upper]
model_grid = model_grid_full[:, :, :, :, ind_lower:ind_upper]
'''
